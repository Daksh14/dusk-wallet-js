<!DOCTYPE html>
<html>
  <head> </head>

  <body>
    <div><p>Well this is awkward</p></div>
    <script type="module">
      ReadableStream.prototype[Symbol.asyncIterator] = async function* () {
        const reader = this.getReader();
        try {
          while (true) {
            const { done, value } = await reader.read();
            if (done) return;
            yield value;
          }
        } finally {
          reader.releaseLock();
        }
      };
      import {
        Wallet,
        generateRandomMnemonic,
        getTreeLeafDeserialized,
      } from "../dist/wallet.js";
      // Default wallet seed
      const seed = [
        219, 97, 4, 38, 84, 132, 220, 244, 238, 137, 105, 215, 12, 127, 226,
        151, 123, 180, 220, 255, 193, 65, 242, 254, 127, 208, 56, 72, 145, 142,
        74, 86, 122, 62, 47, 108, 25, 154, 50, 13, 127, 140, 154, 156, 137, 46,
        150, 210, 32, 152, 152, 242, 214, 140, 209, 190, 33, 69, 234, 202, 8,
        39, 64, 7,
      ];

      let memory;

      const imports = {
        env: {
          log_string(ptr, len) {
            console.log(readString(ptr, len));
          },
        },
      };

      function readString(ptr, len) {
        const view = new Uint8Array(memory.buffer);

        const buf = new Uint8Array(view.subarray(ptr, ptr + len));
        return new TextDecoder().decode(buf);
      }

      const initWasm = async () => {
        fetch("../assets/dusk-wallet-core-0.21.0.wasm")
          .then((response) => response.arrayBuffer())
          .then((buffer) => WebAssembly.instantiate(buffer, imports))
          .then(async (result) => {
            console.log("wasm loaded!: ", result);
            const exports = result.instance.exports;
            memory = exports.memory;

            let wallet = new Wallet(exports, seed);
            let psks = wallet.getPsks();

            // console.log(getTreeLeafDeserialized(exports, leaf));

            let sync = await wallet.sync();

            console.log(await wallet.history(psks[0]));

            // await wallet.transfer(psks[0], psks[1], 193);
          })
          .catch((err) =>
            setTimeout(() => {
              throw err;
            })
          );
      };

      console.log("test");

      initWasm().catch((e) => console.error(e));
    </script>
  </body>
</html>
