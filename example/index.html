<!DOCTYPE html>
<html>
  <head> </head>

  <body>
    <div><p>Well this is awkward</p></div>
    <script type="module">
      ReadableStream.prototype[Symbol.asyncIterator] = async function* () {
        const reader = this.getReader();
        try {
          while (true) {
            const { done, value } = await reader.read();
            if (done) return;
            yield value;
          }
        } finally {
          reader.releaseLock();
        }
      };
      import { Wallet, generateRandomMnemonic } from "../dist/wallet.js";
      // Default wallet seed
      const seed = [
        153, 16, 102, 99, 133, 196, 55, 237, 42, 2, 163, 116, 233, 89, 10, 115,
        19, 81, 140, 31, 38, 81, 10, 46, 118, 112, 151, 244, 145, 90, 145, 168,
        214, 242, 68, 123, 116, 76, 223, 56, 200, 60, 188, 217, 34, 113, 55,
        172, 27, 255, 184, 55, 143, 233, 109, 20, 137, 34, 20, 196, 252, 117,
        221, 221,
      ];

      let memory;

      const imports = {
        env: {
          log_string(ptr, len) {
            console.log(readString(ptr, len));
          },
        },
      };

      function readString(ptr, len) {
        const view = new Uint8Array(memory.buffer);

        const buf = new Uint8Array(view.subarray(ptr, ptr + len));
        return new TextDecoder().decode(buf);
      }

      const initWasm = async () => {
        fetch("../assets/dusk-wallet-core-0.21.0.wasm")
          .then((response) => response.arrayBuffer())
          .then((buffer) => WebAssembly.instantiate(buffer, imports))
          .then(async (result) => {
            console.log("wasm loaded!: ", result);
            const exports = result.instance.exports;
            memory = exports.memory;

            let wallet = new Wallet(exports, seed);
            let psks = wallet.getPsks();
            console.log(psks);

            // console.log(getTreeLeafDeserialized(exports, leaf));

            let sync = await wallet.sync();

            console.log(await wallet.history(psks[0]));

            // await wallet.transfer(psks[0], psks[1], 193);
          })
          .catch((err) =>
            setTimeout(() => {
              throw err;
            })
          );
      };

      console.log("test");

      initWasm().catch((e) => console.error(e));
    </script>
  </body>
</html>
